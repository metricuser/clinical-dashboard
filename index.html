<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clinical Metrics Dashboard - Summaries</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #eee; }
    select, button { margin: 10px 5px 0 0; padding: 5px 10px; }
    .summary-section { margin-top: 30px; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Clinical Metrics Dashboard</h2>
  <label for="facilityFilter">Facility:</label>
  <select id="facilityFilter"><option value="All">All</option></select>

  <label for="segmentFilter">Segment:</label>
  <select id="segmentFilter"><option value="All">All</option></select>

  <label for="monthFilter">Month:</label>
  <select id="monthFilter">
    <option value="All">All</option>
    <option>January</option><option>February</option><option>March</option>
  </select>

  <label for="yearFilter">Year:</label>
  <select id="yearFilter"><option value="All">All</option></select>

  <button onclick="exportCSV()">Export CSV</button>

  <table>
    <thead>
      <tr>
        <th>Facility</th><th>Segment</th><th>Month</th><th>Year</th>
        <th>APW Residents</th><th>APW%</th>
        <th>SWL Residents</th><th>SWL%</th>
        <th>Falls Residents</th><th>Falls%</th>
        <th>Census</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="summary-section">
    <h3>Quarterly & Annual Averages (Census-Weighted)</h3>
    <pre id="summaryOutput">Calculating...</pre>
  </div>

  <script>
    const data = [
      { facility: "Allis", segment: "Midwest", month: "March", year: 2025, apw: 9, apwPct: "10.2%", swl: 4, swlPct: "4.5%", falls: 7, fallsPct: "8.0%", census: 88 },
      { facility: "Best Care", segment: "Southern Hospitality", month: "March", year: 2025, apw: 1, apwPct: "1.3%", swl: 5, swlPct: "6.6%", falls: 13, fallsPct: "16.9%", census: 77 },
      { facility: "Bradford", segment: "Northern Pride", month: "February", year: 2024, apw: 4, apwPct: "5.3%", swl: 13, swlPct: "17.1%", falls: 13, fallsPct: "17.1%", census: 76 }
    ];

    const monthToQuarter = {
      January: "Q1", February: "Q1", March: "Q1",
      April: "Q2", May: "Q2", June: "Q2",
      July: "Q3", August: "Q3", September: "Q3",
      October: "Q4", November: "Q4", December: "Q4"
    };

    function populateFilters() {
      const facilitySet = new Set();
      const segmentSet = new Set();
      const yearSet = new Set();

      data.forEach(d => {
        facilitySet.add(d.facility);
        segmentSet.add(d.segment);
        yearSet.add(d.year);
      });

      const addOptions = (id, values) => {
        const select = document.getElementById(id);
        values.sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });
      };

      addOptions("facilityFilter", [...facilitySet]);
      addOptions("segmentFilter", [...segmentSet]);
      addOptions("yearFilter", [...yearSet]);
    }

    function applyFilters() {
      const month = document.getElementById("monthFilter").value;
      const facility = document.getElementById("facilityFilter").value;
      const segment = document.getElementById("segmentFilter").value;
      const year = document.getElementById("yearFilter").value;

      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      const filtered = data.filter(d =>
        (month === "All" || d.month === month) &&
        (facility === "All" || d.facility === facility) &&
        (segment === "All" || d.segment === segment) &&
        (year === "All" || d.year.toString() === year)
      ).sort((a, b) => a.facility.localeCompare(b.facility));

      filtered.forEach(d => {
        const row = `<tr>
          <td>${d.facility}</td><td>${d.segment}</td><td>${d.month}</td><td>${d.year}</td>
          <td>${d.apw}</td><td>${d.apwPct}</td>
          <td>${d.swl}</td><td>${d.swlPct}</td>
          <td>${d.falls}</td><td>${d.fallsPct}</td>
          <td>${d.census}</td>
        </tr>`;
        tbody.innerHTML += row;
      });

      generateSummaries(filtered);
      return filtered;
    }

    function generateSummaries(entries) {
      const quarters = {}, years = {};
      const addTo = (obj, key, census, apw, swl, falls) => {
        if (!obj[key]) obj[key] = { census: 0, apw: 0, swl: 0, falls: 0 };
        obj[key].census += census;
        obj[key].apw += apw;
        obj[key].swl += swl;
        obj[key].falls += falls;
      };

      entries.forEach(d => {
        const q = monthToQuarter[d.month] || "Unknown";
        const y = d.year;
        addTo(quarters, q, d.census, d.apw, d.swl, d.falls);
        addTo(years, y, d.census, d.apw, d.swl, d.falls);
      });

      let output = "QUARTERLY AVERAGES:\n";
      for (const q in quarters) {
        const { census, apw, swl, falls } = quarters[q];
        const pct = v => census ? (v / census * 100).toFixed(1) + "%" : "0.0%";
        output += ` - ${q}: APW ${pct(apw)}, SWL ${pct(swl)}, Falls ${pct(falls)}\n`;
      }

      output += "\nANNUAL AVERAGES:\n";
      for (const y in years) {
        const { census, apw, swl, falls } = years[y];
        const pct = v => census ? (v / census * 100).toFixed(1) + "%" : "0.0%";
        output += ` - ${y}: APW ${pct(apw)}, SWL ${pct(swl)}, Falls ${pct(falls)}\n`;
      }

      document.getElementById("summaryOutput").textContent = output;
    }

    function exportCSV() {
      const filtered = applyFilters();
      const headers = [
        "Facility", "Segment", "Month", "Year",
        "APW Residents", "APW%", "SWL Residents", "SWL%",
        "Falls Residents", "Falls%", "Census"
      ];
      const rows = filtered.map(d => [
        d.facility, d.segment, d.month, d.year,
        d.apw, d.apwPct, d.swl, d.swlPct, d.falls, d.fallsPct, d.census
      ]);

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "filtered_clinical_metrics.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    window.onload = () => {
      populateFilters();
      applyFilters();
      ["monthFilter", "facilityFilter", "segmentFilter", "yearFilter"].forEach(id => {
        document.getElementById(id).onchange = applyFilters;
      });
    };
  </script>
</body>
</html>