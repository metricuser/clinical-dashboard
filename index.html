
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinical Metrics Dashboard</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    form, table { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 5px #ccc; margin-bottom: 20px; }
    input, select, button, textarea { padding: 6px; margin: 6px 0; width: 100%; max-width: 300px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
    .high { color: red; font-weight: bold; }
    .moderate { color: orange; font-weight: bold; }
    .low { color: green; font-weight: bold; }
  </style>
</head>
<body>
<h1>Clinical Metrics Entry</h1>
<form id="entryForm">
  <select name="facilityName" required>
    <option value="">Select Facility</option>
    <option>Allis</option><option>Buchanan</option><option>Siena Woods</option>
  </select>
  <input name="segment" placeholder="Segment" readonly />
  <select name="month" required>
    <option value="">Month</option><option>January</option><option>February</option>
  </select>
  <select name="year" required>
    <option value="">Year</option><option>2024</option><option>2025</option>
  </select>
  <input name="apwResidents" placeholder="APW Residents" type="number" />
  <input name="swlResidents" placeholder="SWL Residents" type="number" />
  <input name="fallsResidents" placeholder="Falls Residents" type="number" />
  <input name="census" placeholder="Census" type="number" />
  <button type="submit">Submit</button>
</form>

<h2>Segment Averages by Month/Year</h2>
<div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 5px #ccc;margin-bottom:20px;">
  <label>Month:
    <select id="segmentMonth">
      <option value="">All Months</option>
      <option>January</option><option>February</option><option>March</option><option>April</option>
      <option>May</option><option>June</option><option>July</option><option>August</option>
      <option>September</option><option>October</option><option>November</option><option>December</option>
    </select>
  </label>
  <label>Year:
    <select id="segmentYear">
      <option value="">All Years</option>
      <option>2024</option><option>2025</option><option>2026</option><option>2027</option><option>2028</option>
    </select>
  </label>
  <button onclick="loadSegmentAverages()">Refresh</button>
  <table style="margin-top:15px;width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>Segment</th>
        <th>Avg APW%</th>
        <th>Avg SWL%</th>
        <th>Avg Falls%</th>
      </tr>
    </thead>
    <tbody id="segmentTable"></tbody>
  </table>
</div>

<h2>Submitted Entries</h2>
<table>
  <thead>
    <tr>
      <th>Facility</th><th>Segment</th><th>Month</th><th>Year</th><th>Census</th>
      <th>APW%</th><th>APW Risk</th>
      <th>SWL%</th><th>SWL Risk</th>
      <th>Falls%</th><th>Falls Risk</th>
    </tr>
  </thead>
  <tbody id="dataBody"></tbody>
</table>

<script>
const facilitySegments = {
  "Allis": "Midwest", "Buchanan": "Southern Hospitality", "Siena Woods": "Northern Pride"
};
document.querySelector('[name="facilityName"]').onchange = e => {
  document.querySelector('[name="segment"]').value = facilitySegments[e.target.value] || "";
};

document.getElementById("entryForm").onsubmit = function(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const entry = Object.fromEntries(formData.entries());
  Object.keys(entry).forEach(k => { if (!isNaN(entry[k])) entry[k] = Number(entry[k]); });
  displayEntry(entry);
  e.target.reset();
};

function getPct(value, total) {
  return total ? ((value / total) * 100).toFixed(1) : "0.0";
}
function getRisk(pct, high, mod) {
  const val = parseFloat(pct);
  if (val >= high) return '<span class="high">High</span>';
  if (val >= mod) return '<span class="moderate">Moderate</span>';
  return '<span class="low">Low</span>';
}

function displayEntry(entry) {
  const body = document.getElementById("dataBody");
  const tr = document.createElement("tr");
  const apwPct = getPct(entry.apwResidents, entry.census);
  const swlPct = getPct(entry.swlResidents, entry.census);
  const fallPct = getPct(entry.fallsResidents, entry.census);
  tr.innerHTML = `
    <td>${entry.facilityName}</td><td>${entry.segment}</td><td>${entry.month}</td><td>${entry.year}</td><td>${entry.census}</td>
    <td>${apwPct}%</td><td>${getRisk(apwPct, 6, 3)}</td>
    <td>${swlPct}%</td><td>${getRisk(swlPct, 10, 5)}</td>
    <td>${fallPct}%</td><td>${getRisk(fallPct, 15, 8)}</td>
  `;
  body.appendChild(tr);
}

function loadSegmentAverages() {
  fetch("https://clinical-metrics-api.onrender.com/entries")
    .then(res => res.json())
    .then(data => {
      const month = document.getElementById("segmentMonth").value;
      const year = document.getElementById("segmentYear").value;
      const segments = {
        "Midwest": [], "Southern Hospitality": [], "Northern Pride": []
      };

      data.forEach(entry => {
        if ((month && entry.month !== month) || (year && entry.year !== year)) return;
        if (!entry.segment || !entry.census) return;

        const seg = segments[entry.segment];
        if (!seg) return;

        seg.push({
          apw: parseFloat(entry.apwResidents || 0),
          swl: parseFloat(entry.swlResidents || 0),
          falls: parseFloat(entry.fallsResidents || 0),
          census: parseFloat(entry.census || 0)
        });
      });

      const tbody = document.getElementById("segmentTable");
      tbody.innerHTML = "";

      Object.keys(segments).forEach(name => {
        const entries = segments[name];
        let totalApw = 0, totalSwl = 0, totalFalls = 0, totalCensus = 0;

        entries.forEach(e => {
          totalApw += e.apw;
          totalSwl += e.swl;
          totalFalls += e.falls;
          totalCensus += e.census;
        });

        const avgApw = totalCensus ? (totalApw / totalCensus * 100).toFixed(1) : "0.0";
        const avgSwl = totalCensus ? (totalSwl / totalCensus * 100).toFixed(1) : "0.0";
        const avgFalls = totalCensus ? (totalFalls / totalCensus * 100).toFixed(1) : "0.0";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${name}</td>
          <td>${avgApw}%</td>
          <td>${avgSwl}%</td>
          <td>${avgFalls}%</td>
        `;
        tbody.appendChild(row);
      });
    });
}
</script>
</body>
</html>
